/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./defined-b9ff0e39","./Check-e6691f86","./freezeObject-2d5b18ce","./defaultValue-199f5aa8","./Math-92bd3539","./Cartesian2-8fa798b8","./defineProperties-ae15c9d5","./objectToQuery-2e382d4d","./Transforms-c1305e13","./RuntimeError-d5522ee3","./WebGLConstants-554ddbe2","./when-c208a7cf","./AttributeCompression-4cb3e905","./IndexDatatype-7119db15","./IntersectionTests-0268f2ee","./Plane-c6867c84","./createTaskProcessorWorker","./EllipsoidTangentPlane-29b9a994","./OrientedBoundingBox-dd67ef28","./Color-c6da1cc9"],function(Ne,e,a,r,ke,Be,n,t,i,o,s,f,Le,Oe,d,c,u,h,Pe,Ue){"use strict";var Fe=new Be.Cartesian3,Se=new Be.Ellipsoid,Re=new Be.Rectangle,De={min:void 0,max:void 0,indexBytesPerElement:void 0};function Me(e,a,r){var n=a.length,t=2+n*Pe.OrientedBoundingBox.packedLength+1+function(e){for(var a=e.length,r=0,n=0;n<a;++n)r+=Ue.Color.packedLength+3+e[n].batchIds.length;return r}(r),i=new Float64Array(t),o=0;i[o++]=e,i[o++]=n;for(var s=0;s<n;++s)Pe.OrientedBoundingBox.pack(a[s],i,o),o+=Pe.OrientedBoundingBox.packedLength;var f=r.length;i[o++]=f;for(var d=0;d<f;++d){var c=r[d];Ue.Color.pack(c.color,i,o),o+=Ue.Color.packedLength,i[o++]=c.offset,i[o++]=c.count;var u=c.batchIds,h=u.length;i[o++]=h;for(var l=0;l<h;++l)i[o++]=u[l]}return i}var _e=new Be.Cartesian3,Ge=new Be.Cartesian3,Ve=new Be.Cartesian3,Ye=new Be.Cartesian3,He=new Be.Cartesian3,je=new Be.Cartographic,ze=new Be.Rectangle;return u(function(e,a){var r;!function(e){var a=new Float64Array(e),r=0;De.indexBytesPerElement=a[r++],De.min=a[r++],De.max=a[r++],Be.Cartesian3.unpack(a,r,Fe),r+=Be.Cartesian3.packedLength,Be.Ellipsoid.unpack(a,r,Se),r+=Be.Ellipsoid.packedLength,Be.Rectangle.unpack(a,r,Re)}(e.packedBuffer),r=2===De.indexBytesPerElement?new Uint16Array(e.indices):new Uint32Array(e.indices);var n,t,i,o=new Uint16Array(e.positions),s=new Uint32Array(e.counts),f=new Uint32Array(e.indexCounts),d=new Uint32Array(e.batchIds),c=new Uint32Array(e.batchTableColors),u=new Array(s.length),h=Fe,l=Se,g=Re,p=De.min,b=De.max,y=e.minimumHeights,C=e.maximumHeights;Ne.defined(y)&&Ne.defined(C)&&(y=new Float32Array(y),C=new Float32Array(C));var v=o.length/2,I=o.subarray(0,v),m=o.subarray(v,2*v);Le.AttributeCompression.zigZagDeltaDecode(I,m);var w=new Float32Array(3*v);for(n=0;n<v;++n){var x=I[n],A=m[n],T=ke.CesiumMath.lerp(g.west,g.east,x/32767),E=ke.CesiumMath.lerp(g.south,g.north,A/32767),N=Be.Cartographic.fromRadians(T,E,0,je),k=l.cartographicToCartesian(N,_e);Be.Cartesian3.pack(k,w,3*n)}var B=s.length,L=new Array(B),O=new Array(B),P=0,U=0;for(n=0;n<B;++n)L[n]=P,O[n]=U,P+=s[n],U+=f[n];var F,S=new Float32Array(3*v*2),R=new Uint16Array(2*v),D=new Uint32Array(O.length),M=new Uint32Array(f.length),_=[],G={};for(n=0;n<B;++n)i=c[n],Ne.defined(G[i])?(G[i].positionLength+=s[n],G[i].indexLength+=f[n],G[i].batchIds.push(n)):G[i]={positionLength:s[n],indexLength:f[n],offset:0,indexOffset:0,batchIds:[n]};var V=0,Y=0;for(i in G)if(G.hasOwnProperty(i)){(F=G[i]).offset=V,F.indexOffset=Y;var H=2*F.positionLength,j=2*F.indexLength+6*F.positionLength;V+=H,Y+=j,F.indexLength=j}var z=[];for(i in G)G.hasOwnProperty(i)&&(F=G[i],z.push({color:Ue.Color.fromRgba(parseInt(i)),offset:F.indexOffset,count:F.indexLength,batchIds:F.batchIds}));for(n=0;n<B;++n){var W=(F=G[i=c[n]]).offset,Q=3*W,Z=W,q=L[n],J=s[n],K=d[n],X=p,$=b;Ne.defined(y)&&Ne.defined(C)&&(X=y[n],$=C[n]);var ee=Number.POSITIVE_INFINITY,ae=Number.NEGATIVE_INFINITY,re=Number.POSITIVE_INFINITY,ne=Number.NEGATIVE_INFINITY;for(t=0;t<J;++t){var te=Be.Cartesian3.unpack(w,3*q+3*t,_e);l.scaleToGeodeticSurface(te,te);var ie=l.cartesianToCartographic(te,je),oe=ie.latitude,se=ie.longitude;ee=Math.min(oe,ee),ae=Math.max(oe,ae),re=Math.min(se,re),ne=Math.max(se,ne);var fe=l.geodeticSurfaceNormal(te,Ge),de=Be.Cartesian3.multiplyByScalar(fe,X,Ve),ce=Be.Cartesian3.add(te,de,Ye);de=Be.Cartesian3.multiplyByScalar(fe,$,de);var ue=Be.Cartesian3.add(te,de,He);Be.Cartesian3.subtract(ue,h,ue),Be.Cartesian3.subtract(ce,h,ce),Be.Cartesian3.pack(ue,S,Q),Be.Cartesian3.pack(ce,S,Q+3),R[Z]=K,R[Z+1]=K,Q+=6,Z+=2}(g=ze).west=re,g.east=ne,g.south=ee,g.north=ae,u[n]=Pe.OrientedBoundingBox.fromRectangle(g,p,b,l);var he=F.indexOffset,le=O[n],ge=f[n];for(D[n]=he,t=0;t<ge;t+=3){var pe=r[le+t]-q,be=r[le+t+1]-q,ye=r[le+t+2]-q;_[he++]=2*pe+W,_[he++]=2*be+W,_[he++]=2*ye+W,_[he++]=2*ye+1+W,_[he++]=2*be+1+W,_[he++]=2*pe+1+W}for(t=0;t<J;++t){var Ce=t,ve=(t+1)%J;_[he++]=2*Ce+1+W,_[he++]=2*ve+W,_[he++]=2*Ce+W,_[he++]=2*Ce+1+W,_[he++]=2*ve+1+W,_[he++]=2*ve+W}F.offset+=2*J,F.indexOffset=he,M[n]=he-D[n]}_=Oe.IndexDatatype.createTypedArray(S.length/3,_);for(var Ie=z.length,me=0;me<Ie;++me){for(var we=z[me].batchIds,xe=0,Ae=we.length,Te=0;Te<Ae;++Te)xe+=M[we[Te]];z[me].count=xe}var Ee=Me(2===_.BYTES_PER_ELEMENT?Oe.IndexDatatype.UNSIGNED_SHORT:Oe.IndexDatatype.UNSIGNED_INT,u,z);return a.push(S.buffer,_.buffer,D.buffer,M.buffer,R.buffer,Ee.buffer),{positions:S.buffer,indices:_.buffer,indexOffsets:D.buffer,indexCounts:M.buffer,batchIds:R.buffer,packedBuffer:Ee.buffer}})});
