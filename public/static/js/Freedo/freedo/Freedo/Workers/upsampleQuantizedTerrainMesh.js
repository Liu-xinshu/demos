/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./defined-b9ff0e39","./Check-e6691f86","./freezeObject-2d5b18ce","./defaultValue-199f5aa8","./Math-92bd3539","./Cartesian2-8fa798b8","./defineProperties-ae15c9d5","./objectToQuery-2e382d4d","./Transforms-c1305e13","./RuntimeError-d5522ee3","./WebGLConstants-554ddbe2","./ComponentDatatype-569c1e3e","./when-c208a7cf","./AttributeCompression-4cb3e905","./IndexDatatype-7119db15","./IntersectionTests-0268f2ee","./Plane-c6867c84","./createTaskProcessorWorker","./EllipsoidTangentPlane-29b9a994","./OrientedBoundingBox-dd67ef28","./EllipsoidalOccluder-2722e07a","./TerrainEncoding-d3ac3c0e"],function(C,e,t,i,xe,ve,n,s,Ce,r,h,u,o,a,we,ye,p,d,f,Be,Ie,Te){"use strict";var be={clipTriangleAtAxisAlignedThreshold:function(e,t,i,n,s,r){var h,u,o;C.defined(r)?r.length=0:r=[],o=t?(h=i<e,u=n<e,s<e):(h=e<i,u=e<n,e<s);var a,p,d,f,l,c,g=h+u+o;return 1===g?h?(a=(e-i)/(n-i),p=(e-i)/(s-i),r.push(1),r.push(2),1!==p&&(r.push(-1),r.push(0),r.push(2),r.push(p)),1!==a&&(r.push(-1),r.push(0),r.push(1),r.push(a))):u?(d=(e-n)/(s-n),f=(e-n)/(i-n),r.push(2),r.push(0),1!==f&&(r.push(-1),r.push(1),r.push(0),r.push(f)),1!==d&&(r.push(-1),r.push(1),r.push(2),r.push(d))):o&&(l=(e-s)/(i-s),c=(e-s)/(n-s),r.push(0),r.push(1),1!==c&&(r.push(-1),r.push(2),r.push(1),r.push(c)),1!==l&&(r.push(-1),r.push(2),r.push(0),r.push(l))):2===g?h||i===e?u||n===e?o||s===e||(p=(e-i)/(s-i),d=(e-n)/(s-n),r.push(2),r.push(-1),r.push(0),r.push(2),r.push(p),r.push(-1),r.push(1),r.push(2),r.push(d)):(c=(e-s)/(n-s),a=(e-i)/(n-i),r.push(1),r.push(-1),r.push(2),r.push(1),r.push(c),r.push(-1),r.push(0),r.push(1),r.push(a)):(f=(e-n)/(i-n),l=(e-s)/(i-s),r.push(0),r.push(-1),r.push(1),r.push(0),r.push(f),r.push(-1),r.push(2),r.push(0),r.push(l)):3!==g&&(r.push(0),r.push(1),r.push(2)),r},computeBarycentricCoordinates:function(e,t,i,n,s,r,h,u,o){var a=i-h,p=h-s,d=r-u,f=n-u,l=1/(d*a+p*f),c=t-u,g=e-h,m=(d*g+p*c)*l,x=(-f*g+a*c)*l,v=1-m-x;return C.defined(o)?(o.x=m,o.y=x,o.z=v,o):new ve.Cartesian3(m,x,v)},computeLineSegmentLineSegmentIntersection:function(e,t,i,n,s,r,h,u,o){var a=(u-r)*(i-e)-(h-s)*(n-t);if(0!=a){var p=((h-s)*(t-r)-(u-r)*(e-s))/a,d=((i-e)*(t-r)-(n-t)*(e-s))/a;return 0<=p&&p<=1&&0<=d&&d<=1?(C.defined(o)||(o=new ve.Cartesian2),o.x=e+p*(i-e),o.y=t+p*(n-t),o):void 0}}},Ae=32767,ze=16383,Ee=[],Me=[],Re=[],Ve=new ve.Cartographic,Ne=new ve.Cartesian3,Oe=[],He=[],Se=[],Fe=[],Pe=[],Ue=new ve.Cartesian3,We=new Ce.BoundingSphere,ke=new Be.OrientedBoundingBox,De=new ve.Cartesian2,Xe=new ve.Cartesian3;function Ke(){this.vertexBuffer=void 0,this.index=void 0,this.first=void 0,this.second=void 0,this.ratio=void 0}Ke.prototype.clone=function(e){return C.defined(e)||(e=new Ke),e.uBuffer=this.uBuffer,e.vBuffer=this.vBuffer,e.heightBuffer=this.heightBuffer,e.normalBuffer=this.normalBuffer,e.index=this.index,e.first=this.first,e.second=this.second,e.ratio=this.ratio,e},Ke.prototype.initializeIndexed=function(e,t,i,n,s){this.uBuffer=e,this.vBuffer=t,this.heightBuffer=i,this.normalBuffer=n,this.index=s,this.first=void 0,this.second=void 0,this.ratio=void 0},Ke.prototype.initializeFromClipResult=function(e,t,i){var n=t+1;return-1!==e[t]?i[e[t]].clone(this):(this.vertexBuffer=void 0,this.index=void 0,this.first=i[e[n]],++n,this.second=i[e[n]],++n,this.ratio=e[n],++n),n},Ke.prototype.getKey=function(){return this.isIndexed()?this.index:JSON.stringify({first:this.first.getKey(),second:this.second.getKey(),ratio:this.ratio})},Ke.prototype.isIndexed=function(){return C.defined(this.index)},Ke.prototype.getH=function(){return C.defined(this.index)?this.heightBuffer[this.index]:xe.CesiumMath.lerp(this.first.getH(),this.second.getH(),this.ratio)},Ke.prototype.getU=function(){return C.defined(this.index)?this.uBuffer[this.index]:xe.CesiumMath.lerp(this.first.getU(),this.second.getU(),this.ratio)},Ke.prototype.getV=function(){return C.defined(this.index)?this.vBuffer[this.index]:xe.CesiumMath.lerp(this.first.getV(),this.second.getV(),this.ratio)};var l=new ve.Cartesian2,c=-1,g=[new ve.Cartesian3,new ve.Cartesian3],m=[new ve.Cartesian3,new ve.Cartesian3];function x(e,t){var i=g[++c],n=m[c];return i=a.AttributeCompression.octDecode(e.first.getNormalX(),e.first.getNormalY(),i),n=a.AttributeCompression.octDecode(e.second.getNormalX(),e.second.getNormalY(),n),Ne=ve.Cartesian3.lerp(i,n,e.ratio,Ne),ve.Cartesian3.normalize(Ne,Ne),a.AttributeCompression.octEncode(Ne,t),--c,t}Ke.prototype.getNormalX=function(){return C.defined(this.index)?this.normalBuffer[2*this.index]:(l=x(this,l)).x},Ke.prototype.getNormalY=function(){return C.defined(this.index)?this.normalBuffer[2*this.index+1]:(l=x(this,l)).y};var v=[];function Le(e,t,i,n,s,r,h,u,o){if(0!==h.length){for(var a=0,p=0;p<h.length;)p=v[a++].initializeFromClipResult(h,p,u);for(var d=0;d<a;++d){var f=v[d];if(f.isIndexed())f.newIndex=r[f.index],f.uBuffer=e,f.vBuffer=t,f.heightBuffer=i,o&&(f.normalBuffer=n);else{var l=f.getKey();if(C.defined(r[l]))f.newIndex=r[l];else{var c=e.length;e.push(f.getU()),t.push(f.getV()),i.push(f.getH()),o&&(n.push(f.getNormalX()),n.push(f.getNormalY())),f.newIndex=c,r[l]=c}}}3===a?(s.push(v[0].newIndex),s.push(v[1].newIndex),s.push(v[2].newIndex)):4===a&&(s.push(v[0].newIndex),s.push(v[1].newIndex),s.push(v[2].newIndex),s.push(v[0].newIndex),s.push(v[2].newIndex),s.push(v[3].newIndex))}}return v.push(new Ke),v.push(new Ke),v.push(new Ke),v.push(new Ke),d(function(e,t){var i=e.isEastChild,n=e.isNorthChild,s=i?ze:0,r=i?Ae:ze,h=n?ze:0,u=n?Ae:ze,o=Oe,a=He,p=Se,d=Pe;o.length=0,a.length=0,p.length=0,d.length=0;var f=Fe;f.length=0;var l={},c=e.vertices,g=e.indices;g=g.subarray(0,e.skirtIndex);var m,x,v,C,w,y=Te.TerrainEncoding.clone(e.encoding),B=y.hasVertexNormals,I=e.exaggeration,T=0,b=e.vertexCountWithoutSkirts,A=e.minimumHeight,z=e.maximumHeight,E=new Array(b),M=new Array(b),R=new Array(b),V=B?new Array(2*b):void 0;for(v=x=0;x<b;++x,v+=2){var N=y.decodeTextureCoordinates(c,x,De);if(m=y.decodeHeight(c,x)/I,C=xe.CesiumMath.clamp(N.x*Ae|0,0,Ae),w=xe.CesiumMath.clamp(N.y*Ae|0,0,Ae),R[x]=xe.CesiumMath.clamp((m-A)/(z-A)*Ae|0,0,Ae),C<20&&(C=0),w<20&&(w=0),Ae-C<20&&(C=Ae),Ae-w<20&&(w=Ae),E[x]=C,M[x]=w,B){var O=y.getOctEncodedNormal(c,x,Xe);V[v]=O.x,V[v+1]=O.y}(i&&ze<=C||!i&&C<=ze)&&(n&&ze<=w||!n&&w<=ze)&&(l[x]=T,o.push(C),a.push(w),p.push(R[x]),B&&(d.push(V[v]),d.push(V[v+1])),++T)}var H=[];H.push(new Ke),H.push(new Ke),H.push(new Ke);var S,F=[];for(F.push(new Ke),F.push(new Ke),F.push(new Ke),x=0;x<g.length;x+=3){var P=g[x],U=g[x+1],W=g[x+2],k=E[P],D=E[U],X=E[W];H[0].initializeIndexed(E,M,R,V,P),H[1].initializeIndexed(E,M,R,V,U),H[2].initializeIndexed(E,M,R,V,W);var K=be.clipTriangleAtAxisAlignedThreshold(ze,i,k,D,X,Ee);(S=0)>=K.length||(S=F[0].initializeFromClipResult(K,S,H))>=K.length||(S=F[1].initializeFromClipResult(K,S,H))>=K.length||(S=F[2].initializeFromClipResult(K,S,H),Le(o,a,p,d,f,l,be.clipTriangleAtAxisAlignedThreshold(ze,n,F[0].getV(),F[1].getV(),F[2].getV(),Me),F,B),S<K.length&&(F[2].clone(F[1]),F[2].initializeFromClipResult(K,S,H),Le(o,a,p,d,f,l,be.clipTriangleAtAxisAlignedThreshold(ze,n,F[0].getV(),F[1].getV(),F[2].getV(),Me),F,B)))}var L=i?-Ae:0,Y=n?-Ae:0,j=[],_=[],G=[],J=[],Q=Number.MAX_VALUE,Z=-Q,q=Re;q.length=0;var $=ve.Ellipsoid.clone(e.ellipsoid),ee=e.childRectangle,te=e.constraintRegions,ie=ye.IntersectionTests.intersetRectangleWithConstraintRegion(ee,te),ne=ee.north,se=ee.south,re=ee.east,he=ee.west;for(re<he&&(re+=xe.CesiumMath.TWO_PI),x=0;x<o.length;++x){if(C=(C=Math.round(o[x]))<=s?(j.push(x),0):r<=C?(G.push(x),Ae):2*C+L,o[x]=C,w=(w=Math.round(a[x]))<=h?(_.push(x),0):u<=w?(J.push(x),Ae):2*w+Y,a[x]=w,m=xe.CesiumMath.lerp(A,z,p[x]/Ae),Ve.longitude=xe.CesiumMath.lerp(he,re,C/Ae),Ve.latitude=xe.CesiumMath.lerp(se,ne,w/Ae),Ve.height=m,-1!==ie){var ue=ye.IntersectionTests.isCartographicInConstraintRegion(Ve,ie,te);-1!==ue&&("ERASE"===te[ue].eraseType?m=te[ue].height:"OFFSET"===te[ue].eraseType?m+=te[ue].height:"SMOOTH"===te[ue].eraseType&&(m=ye.IntersectionTests.interoplateCartographicWhenSmooth(Ve,te[ue]))<te[ue].height&&(m=te[ue].height),p[x]=m,Ve.height=m)}(p[x]=m)<Q&&(Q=m),Z<m&&(Z=m),$.cartographicToCartesian(Ve,Ne),q.push(Ne.x),q.push(Ne.y),q.push(Ne.z)}var oe=Ce.BoundingSphere.fromVertices(q,ve.Cartesian3.ZERO,3,We),ae=Be.OrientedBoundingBox.fromRectangle(ee,Q,Z,$,ke),pe=new Ie.EllipsoidalOccluder($).computeHorizonCullingPointFromVertices(oe.center,q,3,oe.center,Ue),de=Z-Q,fe=new Uint16Array(o.length+a.length+p.length);for(x=0;x<o.length;++x)fe[x]=o[x];var le=o.length;for(x=0;x<a.length;++x)fe[le+x]=a[x];for(le+=a.length,x=0;x<p.length;++x)fe[le+x]=Ae*(p[x]-Q)/de;var ce,ge=we.IndexDatatype.createTypedArray(o.length,f);if(B){var me=new Uint8Array(d);t.push(fe.buffer,ge.buffer,me.buffer),ce=me.buffer}else t.push(fe.buffer,ge.buffer);return{vertices:fe.buffer,encodedNormals:ce,indices:ge.buffer,minimumHeight:Q,maximumHeight:Z,westIndices:j,southIndices:_,eastIndices:G,northIndices:J,boundingSphere:oe,orientedBoundingBox:ae,horizonOcclusionPoint:pe}})});
