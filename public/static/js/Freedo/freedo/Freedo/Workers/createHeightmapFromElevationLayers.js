/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./defined-b9ff0e39","./Check-e6691f86","./freezeObject-2d5b18ce","./defaultValue-199f5aa8","./Math-92bd3539","./Cartesian2-8fa798b8","./defineProperties-ae15c9d5","./objectToQuery-2e382d4d","./when-c208a7cf","./IntersectionTests-0268f2ee","./createTaskProcessorWorker","./GeographicTilingScheme-f1d9e13e"],function(_,e,t,h,i,y,a,r,n,d,l,o){"use strict";var T=0,f=1,u=2;function s(e){this.level=e.level,this.x=e.x,this.y=e.y,this.rectangle=e.rectangle}function g(e,t,i){if(this._samplesPerTile=h.defaultValue(i.samplesPerTile,150),this._templateUrl=i.urlTemplate,this._minLevel=h.defaultValue(i.minLevel,0),this._maxLevel=i.maxLevel,this._numTilesXAtMinLevel=i.numTilesXAtMinLevel,this._numTilesYAtMinLevel=i.numTilesYAtMinLevel,this._dataType=i.datatype,this._rectangle=new y.Rectangle(i.boundingBox.west,i.boundingBox.south,i.boundingBox.east,i.boundingBox.north),this._tilingScheme=new o.GeographicTilingScheme({ellipsoid:y.Ellipsoid.WGS84,rectangle:this._rectangle,numberOfLevelZeroTilesX:i.numTilesXAtMinLevel,numberOfLevelZeroTilesY:i.numTilesYAtMinLevel}),this._avaliablesByLevel=[],i.avaliables&&0<i.avaliables.length)for(var a=new y.Rectangle,r=new y.Rectangle,n=0;n<i.avaliables.length;++n){var l=i.avaliables[n],s=l.level;_.defined(this._avaliablesByLevel[s])||(this._avaliablesByLevel[s]=[]),this._tilingScheme.tileXYToRectangle(l.minX,l.minY,s,a),this._tilingScheme.tileXYToRectangle(l.maxX,l.maxY,s,r),this._avaliablesByLevel[s].push(new y.Rectangle(a.west,r.south,r.east,a.north))}this._layerId=e,this._blackList=[],this._manager=t,this._bufferMap=new Map}s.prototype.toString=function(){return this.level+"_"+this.x+"_"+this.y};var c=new y.Cartesian2;function p(){this._layers=[],this._index=0,this._maxBufferIndexArrayLength=500,this._bufferIndexArray=[]}function v(e,t){return e.timestamp<t.timestamp?-1:e.timestamp>t.timestamp?1:0}g.prototype.getTileKey=function(e,t){var i=this._tilingScheme.positionToTileXY(e,t,c),a=parseInt(i.x),r=parseInt(i.y);return new s({level:t,x:a,y:r,rectangle:this._tilingScheme.tileXYToRectangle(a,r,t)})},g.prototype.getElevationAtTile=function(e,t){var i=t.toString();if(function(e,t){for(var i=e.length;i--;)if(e[i]===t)return!0;return!1}(this._blackList,i))return!1;var a=this._bufferMap.get(i);if(a){n=(new Date).getTime();this._manager.updateBufferIndex(this._layerId,i,n)}else{var r=function(e,t){var i=new XMLHttpRequest;i.open("GET",e,!1),i.overrideMimeType("text/plain; charset=x-user-defined"),i.send(null);var a=i.getResponseHeader("Content-Type");if(a&&-1!==a.indexOf("null"))return null;if(200===i.status&&i.responseText&&!(i.responseText.length<100)){for(var r=i.responseText,n=r.length,l=new ArrayBuffer(n),s=new Uint8Array(l),h=0;h<n;++h){var o=255&r.charCodeAt(h);s[h]=o}return _.defined(t)&&"float32"===t.toLowerCase()?new Float32Array(l):new Int16Array(l)}}(this._templateUrl.replace("{TileMatrix}",t.level).replace("{TileRow}",t.y).replace("{TileCol}",t.x),this._dataType);if(void 0!==r)if(r){a=r,this._bufferMap.set(i,a);var n=(new Date).getTime();this._manager.insertBufferIndex(this._layerId,i,n)}else this._blackList.push(i)}if(!a)return!1;var l=(this._samplesPerTile-1)*(e.longitude-t.rectangle.west)/y.Rectangle.computeWidth(t.rectangle),s=(this._samplesPerTile-1)*(t.rectangle.north-e.latitude)/y.Rectangle.computeHeight(t.rectangle),h=Math.floor(l),o=Math.min(h+1,this._samplesPerTile-1),f=Math.floor(s),u=Math.min(f+1,this._samplesPerTile-1),g=a[f*this._samplesPerTile+h],c=a[f*this._samplesPerTile+o],p=a[u*this._samplesPerTile+h],v=a[u*this._samplesPerTile+o],m=l-h,d=s-f;return e.height=(g*(1-m)+c*m)*(1-d)+(p*(1-m)+v*m)*d,!0},g.prototype.getElevation=function(e,t,i){var a=T;if(!y.Rectangle.contains(this._rectangle,e))return a;for(var r=this._samplesPerTile/(y.Rectangle.computeWidth(this._rectangle)/this._numTilesXAtMinLevel),n=this._minLevel;n<=this._maxLevel;++n){if(t<=r){a=u;break}r*=2}if(n>this._maxLevel){if(r<=i)return T;n=this._maxLevel,a=f}for(var l=!1,s=this._avaliablesByLevel[n],h=0;h<s.length;++h)if(y.Rectangle.contains(s[h],e)){l=!0;break}if(!l)return T;var o=this.getTileKey(e,n);return this.getElevationAtTile(e,o)?a:T},g.prototype.removeBufferData=function(e){this._bufferMap.delete(e)},p.prototype.addLayer=function(e){var t=new g(this._index++,this,e);this._layers.push(t)},p.prototype.getElevation=function(e,t){for(var i=T,a=0;a<this._layers.length;++a){var r=this._layers[a].getElevation(e,t,0);if(r===u)return r;r===f&&(i=r)}return i},p.prototype.insertBufferIndex=function(e,t,i){var a=this._bufferIndexArray,r=this._maxBufferIndexArrayLength;if(a.length===r){var n=a.shift();this.removeBufferData(n)}a.push({layerId:e,tileKey:t,timestamp:i})},p.prototype.removeBufferData=function(e){for(var t=this._layers,i=t.length,a=0;a<i;a++){var r=t[a];if(r._layerId===e.layerId){r.removeBufferData(e.tileKey);break}}},p.prototype.updateBufferIndex=function(e,t,i){for(var a=this._bufferIndexArray,r=a.length,n=0;n<r;n++){var l=a[n];if(l.layerId===e&&l.tileKey===t){l.timestamp=i,a.sort(v);break}}};var b=new p;return l(function(e,t){if("addLayer"===e.method)return b.addLayer(e.layer),{succeed:!0};var i=new y.Rectangle(e.west,e.south,e.east,e.north),a=e.constraintRegions,r=d.IntersectionTests.intersetRectangleWithConstraintRegion(i,a),n=e.heightmapWidth,l=n/y.Rectangle.computeWidth(i),s=y.Rectangle.computeWidth(i)/(n-1),h=y.Rectangle.computeHeight(i)/(n-1),o=new Float32Array(n*n),f=new y.Cartographic,u=0,g=0,c=0;for(u=0;u<n;u++)for(g=0;g<n;g++){f.longitude=i.west+g*s,f.latitude=i.north-u*h,f.height=0;var p=!1;if(-1!==r){var v=d.IntersectionTests.isCartographicInConstraintRegion(f,r,a);if(-1!==v){if("ERASE"===a[v].eraseType)o[c++]=a[v].height;else if("OFFSET"===a[v].eraseType)b.getElevation(f,l)===T&&(f.height=0),o[c++]=f.height+a[v].height;else if("SMOOTH"===a[v].eraseType){var m=d.IntersectionTests.interoplateCartographicWhenSmooth(f,a[v]);m<a[v].height&&(m=a[v].height),o[c++]=m}p=!0}}p||(b.getElevation(f,l)===T&&(f.height=0),o[c++]=f.height)}return t.push(o.buffer),{heightmap:o.buffer}})});
